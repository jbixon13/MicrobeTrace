<div id="map" class="h-100"></div>

  <div class="view-controls" style="z-index:1001">
    <button type="button" id="toggle-map-settings" class="btn btn-light btn-sm">
      <span class="oi oi-cog"></span>
    </button>
    <button type="button" class="btn btn-light btn-sm" data-toggle="modal" data-target="#map-export-modal">
      <span class="oi oi-data-transfer-download"></span>
    </button>
    <button id="map-fit" type="button" class="btn btn-light btn-sm" title="Center and Scale Network">
      <span class="oi oi-target"></span>
    </button>
    <button id="map-layer-upload" type="button" class="btn btn-light btn-sm" title="Upload Map Layer">
      <span class="oi oi-data-transfer-upload"></span>
    </button>
    <input type="file" id="map-file-input" style="display: none" multiple/>
  </div>

  <div id="map-settings-pane" class="left-pane" style="z-index:1000">
    <ul class="nav nav-tabs" role="tablist">
      <li role="presentation" class="nav-item">
        <a href="#map-data-configurations" class="nav-link active" aria-controls="map-data-configurations" role="tab" data-toggle="tab">Data</a>
      </li>
      <li role="presentation" class="nav-item">
        <a href="#map-layer-configurations" class="nav-link" aria-controls="map-layer-configurations" role="tab" data-toggle="tab">Layers</a>
      </li>
      <li role="presentation" class="nav-item">
        <a href="#map-node-configurations" class="nav-link" aria-controls="map-node-configurations" role="tab" data-toggle="tab">Nodes</a>
      </li>
      <li role="presentation" class="nav-item">
        <a href="#map-link-configurations" class="nav-link" aria-controls="map-link-configurations" role="tab" data-toggle="tab">Links</a>
      </li>
    </ul>
    <div class="tab-content">
      <div role="tabpanel" class="tab-pane fade show active" id="map-data-configurations">
        <div class="row">
          <div class="col-12">
            <div class="alert alert-info alert-dismissible" role="alert">
              Please select the most precise geographic data your inputs have.
              <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
          </div>
        </div>
        <div class="form-group row">
          <div class="col-4">Latitude</div>
          <div class="col-8">
            <select id="map-field-lat" class="nodeVariables custom-select custom-select-sm">
              <option selected>None</option>
            </select>
          </div>
        </div>
        <div class="form-group row">
          <div class="col-4">Longitude</div>
          <div class="col-8">
            <select id="map-field-lon" class="nodeVariables custom-select custom-select-sm">
              <option selected>None</option>
            </select>
          </div>
        </div>
        <div class="form-group row">
          <div class="col-4">Census Tract</div>
          <div class="col-8">
            <select id="map-field-tract" class="nodeVariables custom-select custom-select-sm">
              <option selected>None</option>
            </select>
          </div>
        </div>
        <div class="form-group row">
          <div class="col-4">Zipcode</div>
          <div class="col-8">
            <select id="map-field-zipcode" class="nodeVariables custom-select custom-select-sm">
              <option selected>None</option>
            </select>
          </div>
        </div>
        <div class="form-group row">
          <div class="col-4">County</div>
          <div class="col-8">
            <select id="map-field-county" class="nodeVariables custom-select custom-select-sm">
              <option selected>None</option>
            </select>
          </div>
        </div>
        <div class="form-group row">
          <div class="col-4">State</div>
          <div class="col-8">
            <select id="map-field-state" class="nodeVariables custom-select custom-select-sm">
              <option selected>None</option>
            </select>
          </div>
        </div>
        <div class="form-group row">
          <div class="col-4">Country</div>
          <div class="col-8">
            <select id="map-field-country" class="nodeVariables custom-select custom-select-sm">
              <option selected>None</option>
            </select>
          </div>
        </div>
      </div>
      <div role="tabpanel" class="tab-pane fade" id="map-layer-configurations">
        <div class="form-group row">
          <div class="col-4">Countries</div>
          <div class="col-8">
            <div class="btn-group btn-group-toggle btn-group-sm w-100" data-toggle="buttons">
              <label class="btn btn-light active col">
                <input type="radio" name="nodeOptions" id="map-countries-show" autocomplete="off" checked> Show
              </label>
              <label class="btn btn-light col">
                <input type="radio" name="nodeOptions" id="map-countries-hide" autocomplete="off"> Hide
              </label>
            </div>
          </div>
        </div>
        <div class="form-group row">
          <div class="col-4">States</div>
          <div class="col-8">
            <div class="btn-group btn-group-toggle btn-group-sm w-100" data-toggle="buttons">
              <label class="btn btn-light active col">
                <input type="radio" name="nodeOptions" id="map-states-show" autocomplete="off" checked> Show
              </label>
              <label class="btn btn-light col">
                <input type="radio" name="nodeOptions" id="map-states-hide" autocomplete="off"> Hide
              </label>
            </div>
          </div>
        </div>
        <div class="form-group row">
          <div class="col-4">Counties</div>
          <div class="col-8">
            <div class="btn-group btn-group-toggle btn-group-sm w-100" data-toggle="buttons">
              <label class="btn btn-light col">
                <input type="radio" name="nodeOptions" id="map-counties-show" autocomplete="off"> Show
              </label>
              <label class="btn btn-light active col">
                <input type="radio" name="nodeOptions" id="map-counties-hide" autocomplete="off" checked> Hide
              </label>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-12">
            <div class="alert alert-warning alert-dismissible" role="alert">
              Enabling any of the layers below will download tiles from the Internet. <a href="https://github.com/CDCgov/MicrobeTrace/wiki/Tile-Maps">Read More.</a>
              <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
          </div>
        </div>
        <div id="baseRow" class="form-group row ifOnline">
          <div class="col-4">Basemap</div>
          <div class="col-8">
            <div class="btn-group btn-group-toggle btn-group-sm w-100" data-toggle="buttons">
              <label class="btn btn-light col">
                <input type="radio" name="labelOptions" id="map-basemap-show" autocomplete="off"> Show
              </label>
              <label class="btn btn-light active col">
                <input type="radio" name="labelOptions" id="map-basemap-hide" autocomplete="off" checked> Hide
              </label>
            </div>
          </div>
        </div>
        <div class="form-group row ifOnline">
          <div class="col-4">Satellite</div>
          <div class="col-8">
            <div class="btn-group btn-group-toggle btn-group-sm w-100" data-toggle="buttons">
              <label class="btn btn-light col">
                <input type="radio" name="satelliteOptions" id="map-satellite-show" autocomplete="off"> Show
              </label>
              <label class="btn btn-light active col">
                <input type="radio" name="satelliteOptions" id="map-satellite-hide" autocomplete="off" checked> Hide
              </label>
            </div>
          </div>
        </div>
      </div>
      <div role="tabpanel" class="tab-pane fade" id="map-node-configurations">
        <div class="form-group row">
          <div class="col-4">Nodes</div>
          <div class="col-8">
            <div class="btn-group btn-group-toggle btn-group-sm w-100" data-toggle="buttons">
              <label class="btn btn-light active col">
                <input type="radio" name="nodeOptions" id="map-node-show" autocomplete="off" checked> Show
              </label>
              <label class="btn btn-light col">
                <input type="radio" name="nodeOptions" id="map-node-hide" autocomplete="off"> Hide
              </label>
            </div>
          </div>
        </div>
        <div class="form-group row">
          <div class="col-4">Color</div>
          <div class="col-8"><button class="btn btn-sm btn-light w-100 launch-color-options">Color Options</button></div>
        </div>
        <div class="form-group row">
          <div class="col-4">Transparency</div>
          <div class="col-8">
            <input type="range" id="map-node-transparency" min="0.00" max="1.00" step="0.01" value="0.00" />
          </div>
        </div>
        <div class="form-group row">
          <div class="col-4">Jitter</div>
          <div class="col-8">
            <input type="range" id="map-node-jitter" min="0.00" max="5" step="0.05" value="0.00" />
          </div>
        </div>
        <div class="form-group row">
          <div class="col-4"><label for="map-node-tooltip-variable" data-toggle="tooltip" title="What node data should be displayed as a tooltip for the node?">Tooltip</label></div>
          <div class="col-8"><select id="map-node-tooltip-variable" class="custom-select custom-select-sm nodeVariables"><option selected>None</option></select></div>
        </div>
      </div>
      <div role="tabpanel" class="tab-pane fade" id="map-link-configurations">
        <div class="form-group row">
          <div class="col-4">Links</div>
          <div class="col-8">
            <div class="btn-group btn-group-toggle btn-group-sm w-100" data-toggle="buttons">
              <label class="btn btn-light col">
                <input type="radio" name="map-link-options" id="map-link-show" autocomplete="off"> Show
              </label>
              <label class="btn btn-light active col">
                <input type="radio" name="map-link-options" id="map-link-hide" autocomplete="off" checked> Hide
              </label>
            </div>
          </div>
        </div>
        <div class="form-group row">
          <div class="col-4">Color</div>
          <div class="col-8"><button class="btn btn-sm btn-light w-100 launch-color-options">Color Options</button></div>
        </div>
        <div class="form-group row">
          <div class="col-4">Transparency</div>
          <div class="col-8">
            <input type="range" id="map-link-transparency" min="0.00" max="1.00" step="0.01" value="0.00" />
          </div>
        </div>
        <div class="form-group row">
          <div class="col-4">Tooltip</div>
          <div class="col-8">
            <select id="map-link-tooltip-variable" class="linkVariables custom-select custom-select-sm">
              <option selected>None</option>
            </select>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="map-export-modal" class="modal fade" tabindex="-1" role="dialog" data-backdrop="false">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Export Geospatial Data</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <form>
            <div class="form-group row">
              <div class="col-12">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" value="" id="map-export-nodes" checked>
                  <label class="form-check-label" for="map-export-nodes">Nodes</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" value="" id="map-export-links">
                  <label class="form-check-label" for="map-export-links">Links</label>
                </div>
              </div>
            </div>
            <div class="form-group row">
              <div class="col-8">
                <input type="text" id="map-export-file-name" class="form-control form-control-sm" placeholder="Filename" />
              </div>
              <div class="col-4">
                <select id="map-export-file-format" class="form-control form-control-sm">
                  <option selected>geojson</option>
                  <option>shapefile</option>
                </select>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-error" data-dismiss="modal">Cancel</button>
          <button type="button" id="map-export" class="btn btn-primary" data-dismiss="modal">Export</button>
        </div>
      </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
  </div><!-- /.modal -->

  <script>
  (function(){
    if(navigator.onLine){
      $('#map').parent().find('.ifOnline').css('display', 'flex');
    }

    let layers = {
      basemap: L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}{r}.png', {
      	subdomains: 'abcd',
      	maxZoom: 19
      }),
      satellite: L.tileLayer('https://api.mapbox.com/styles/v1/mapbox/satellite-streets-v9/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1IjoiYWFib3lsZXMiLCJhIjoiY2o4b3QxNmtjMDhwNjMzcno4dDd1NnVraSJ9.BkjEa6NM7o7KeTaTHOaIGg')
    };

    let nodes = app.getVisibleNodes();

    app.mapData = {};

    function getMapData(type, callback){
      $.getJSON('data/' + type + '.json', response => {
        app.mapData[type] = response;
        if(['countries', 'states', 'counties'].includes(type)){
          layers[type] = L.geoJSON(app.mapData[type], {
            color: '#dadde0',
            weight: type === 'countries' ? 1 : 0.5,
            fillColor: '#fafaf8',
            fillOpacity: type === 'countries' ? 1 : 0
          });
        }
        callback();
      });
    }

    layers.nodes = {remove: function(){}};
    layers.links = {remove: function(){}};
    let map = L.map('map', {
      center: [30, 0],
      zoom: 3,
      zoomControl: false,
      preferCanvas: true
    });

    L.control.zoom({ position: 'bottomleft' }).addTo(map);

    ['lat', 'lon', 'tract', 'zipcode', 'county', 'state', 'country'].forEach(v => {
      let name = 'map-field-'+v, s = $('#'+name);
      s.on('change', function(e){
        session.style.widgets[name] = e.target.value;
        matchCoordinates();
        drawNodes();
        resetStack();
      });
      if(session.data.nodeFields.includes(v)) s.val(v);
    });

    function matchCoordinates(){
      if(session.style.widgets['map-field-country'] !== 'None'){
        let val = session.style.widgets['map-field-country'];
        nodes.forEach(n => {
          let country = app.mapData.countries.features.find(c => c.id == n[val] || c.properties.name == n[val]);
          if(country){
            n._lat = country.properties._lat,
            n._lon = country.properties._lon
          }
        });
      }
      if(session.style.widgets['map-field-state'] !== 'None'){
        let sval = session.style.widgets['map-field-state'];
        nodes.forEach(n => {
          let state = app.mapData.states.features.find(s => s.properties.usps == n[sval] || s.properties.name == n[sval]);
          if(state){
            n._lat = state.properties._lat;
            n._lon = state.properties._lon;
          }
        });
        // Counties is nested in states because Counties are typically reported by name (rather than a UID like FIPS code),
        // but counties names are non-unique (e.g. there are 31 Washington Counties). Accordingly, if we have a state and a county,
        // We can use county. However, we cannot use county without state.
        if(session.style.widgets['map-field-county'] !== 'None'){
          let cval = session.style.widgets['map-field-county'];
          nodes.forEach(n => {
            let state = app.mapData.states.features.find(s => s.properties.usps == n[sval] || s.properties.name == n[sval]);
            let county = app.mapData.counties.features.find(c => c.properties.NAME.includes(n[cval]) && c.properties.USPS == state.properties.usps);
            if(county){
              n._lat = county.properties._lat;
              n._lon = county.properties._lon;
            }
          });
        }
      }
      if(session.style.widgets['map-field-zipcode'] !== 'None'){
        if(!app.mapData.zipcodes){
          getMapData('zipcodes', matchCoordinates);
          return;
        }
        let val = session.style.widgets['map-field-zipcode'];
        nodes.forEach(n => {
          let zo = app.mapData.zipcodes.find(z => z.zipcode == n[val]);
          if(zo){
            n._lat = zo._lat;
            n._lon = zo._lon;
          }
        });
      }
      if(session.style.widgets['map-field-tract'] !== 'None'){
        if(!app.mapData.tracts){
          getMapData('tracts', matchCoordinates);
          return;
        }
        let val = session.style.widgets['map-field-tract'];
        nodes.forEach(n => {
          let tract = app.mapData.tracts.find(t => t.tract == n[val]);
          if(tract){
            n._lat = tract._lat;
            n._lon = tract._lon;
          }
        });
      }
      if(session.style.widgets['map-field-lat'] !== 'None' && session.style.widgets['map-field-lon'] !== 'None'){
        let lat = session.style.widgets['map-field-lat'],
            lon = session.style.widgets['map-field-lon'];
        nodes.forEach(n => {
          if(typeof n[lat] == 'string'){
            n._lat = (n[lat].includes('S') ? -1 : 1) * parseFloat(n[lat]);
          } else {
            n._lat = n[lat];
          }
          if(typeof n[lon] == 'string'){
            n._lon = (n[lon].includes('W') ? -1 : 1) * parseFloat(n[lon]);
          } else {
            n._lon = n[lon];
          }
        });
      }
      app.geoDM();
    }

    function makeNodeGeoJSON(){
      let geojson = {
        type: 'FeatureCollection',
        features:	[]
      };
      let jitter = session.style.widgets['map-node-jitter'] > 0;
      nodes.forEach(function(d){
        if(d._lat && d._lon){
          geojson.features.push({
            type: 'Feature',
            geometry: {
              type: 'Point',
              coordinates: jitter ? [d._lon + d._jlon, d._lat + d._jlat] : [d._lon, d._lat]
            },
            properties: d
          });
        }
      });
      return geojson;
    }

    function makeLinkGeoJSON(){
      let features = [];
      let jitter = session.style.widgets['map-node-jitter'] > 0;
      app.getVisibleLinks().forEach(function(d){
        if(!d.visible) return;
        let source = nodes.find(node => node.id === d.source);
        let target = nodes.find(node => node.id === d.target);
        if(source && target){
          if(source._lat && source._lon && target._lat && target._lon){
            features.push({
              type: 'Feature',
              geometry: {
                type: 'LineString',
                coordinates: jitter ? [
                  [source._lon + source._jlon, source._lat + source._jlat],
                  [target._lon + target._jlon, target._lat + target._jlat]
                ] : [
                  [source._lon, source._lat],
                  [target._lon, target._lat]
                ]
              },
              properties: d
            });
          }
        }
      });
      return {
        type: 'FeatureCollection',
        features:	features
      };
    }

    function drawNodes(){
      layers.nodes.remove();
      if(!session.style.widgets['map-node-show']) return;
      layers.nodes = L.geoJSON(makeNodeGeoJSON(), {
        pointToLayer: function(feature, latlng){
          return L.markerClusterGroup();
        }
      });
      layers.nodes
        .on('mouseover', showNodeTooltip)
        .on('mouseout', hideTooltip)
        .on('click', clickHandler)
        .addTo(map).bringToFront();
    }

/*    function drawNodes(){
      layers.nodes.remove();
      if(!session.style.widgets['map-node-show']) return;
      let style = {
        fillOpacity: 1 - session.style.widgets['map-node-transparency']
      };
      let fillcolor = session.style.widgets['node-color'],
          colorVariable = session.style.widgets['node-color-variable'];
      layers.nodes = L.geoJSON(makeNodeGeoJSON(), {
        pointToLayer: function(feature, latlng){
          return L.circleMarker(latlng, Object.assign({}, style, {
            color: feature.properties.selected ? session.style.widgets['selected-color'] : '#ffffff',
            fillColor: colorVariable === 'None' ? fillcolor : temp.style.nodeColorMap(feature.properties[colorVariable])
          }));
        }
      });
      layers.nodes
        .on('mouseover', showNodeTooltip)
        .on('mouseout', hideTooltip)
        .on('click', clickHandler)
        .addTo(map).bringToFront();
    }    
*/
    function drawLinks(){
      layers.links.remove();
      if(!session.style.widgets['map-link-show']) return;
      let lcv = session.style.widgets['link-color-variable'];
      let opacity = 1 - session.style.widgets['map-link-transparency'];
      if(lcv === "None"){
        let style = {
          color: session.style.widgets['link-color'],
          opacity: opacity
        };
        layers.links = L.geoJSON(makeLinkGeoJSON(), {style: style});
      } else {
        layers.links = L.geoJSON(makeLinkGeoJSON(), {style: function(l){
          return {
            color: temp.style.linkColorMap(l.properties[lcv]),
            opacity: opacity
          };
        }});
      }
      layers.links
        .on('mouseover', showLinkTooltip)
        .on('mouseout', hideTooltip)
        .addTo(map);
    }

    function showNodeTooltip(e){
      let d = e.sourceTarget.feature.properties;
      let v = session.style.widgets['map-node-tooltip-variable'];
      if(v !== 'None' && d[v]){
        d3.select('#tooltip')
          .html(d[v])
          .style('left', (e.originalEvent.pageX + 8) + 'px')
          .style('top', (e.originalEvent.pageY + 18) + 'px')
          .style('z-index', 1001)
          .transition().duration(100)
          .style('opacity', 1);
      }
    }

    function showLinkTooltip(e){
      let d = e.sourceTarget.feature.properties;
      let v = session.style.widgets['map-link-tooltip-variable'];
      if(v !== 'None' && d[v]){
        d3.select('#tooltip')
          .html(d[v])
          .style('left', (e.originalEvent.pageX + 8) + 'px')
          .style('top', (e.originalEvent.pageY + 18) + 'px')
          .style('z-index', 1001)
          .transition().duration(100)
          .style('opacity', 1);
      }
    }

    function hideTooltip(){
      let tooltip = d3.select('#tooltip');
      tooltip
        .transition().duration(100)
        .style('opacity', 0)
        .on('end', () => tooltip.style('z-index', -1));
    }

    function clickHandler(e){
      let node = e.sourceTarget.feature.properties;
      let d = session.data.nodes.find(d => d.id === node.id);
      if(!e.originalEvent.ctrlKey){
        session.data.nodes
          .filter(node => node.id !== d.id)
          .forEach(node => node.selected = false);
      }
      d.selected = !d.selected;
      $(window).trigger('node-selected');
    }

    $('#toggle-map-settings').on('click', function(){
      let pane = $('#map-settings-pane');
      if(pane.is(':visible')){
        pane.animate({left: '-400px'}, function(){ pane.hide(); });
      } else {
        pane.show(0, function(){ pane.animate({left: '0px'}); });
      }
    });

    $('#map-fit').on('click', function(){
      map.flyToBounds(layers.nodes.getBounds());
    });


    $('#map-layer-upload').on('click', function() {
      $('#map-file-input').click();
    });

    $('#map-file-input').on('change', event => {
      Array.from(event.target.files).forEach(file => {
        const { name } = file;
        if (name.endsWith(".geojson")) {
          const layerName = name.toLowerCase().replace(".geojson", "");
          const reader = new FileReader();
          reader.onload = function(event) {
            app.mapData[layerName] = JSON.parse(event.target.result);
            layers[layerName] = L.geoJSON(app.mapData[layerName], {
              color: '#f00',
              weight: .75,
              fillColor: '#fafaf8',
              fillOpacity: .5
            });
            layers[layerName].addTo(map);
          };
          reader.readAsText(file);
        } else {
          alert("Only GeoJSON Files are currently Supported.");
        }
      });
    });

    function resetStack(){
      //Tile Layers, in reverse order:
      if(layers.satellite && session.style.widgets['map-satellite-show']) layers.satellite.bringToBack();
      if(layers.basemap && session.style.widgets['map-basemap-show']) layers.basemap.bringToBack();

      //Background Layers, in order:
      if(layers.countries && session.style.widgets['map-countries-show']) layers.countries.bringToFront();
      if(layers.states && session.style.widgets['map-states-show']) layers.states.bringToFront();
      if(layers.counties && session.style.widgets['map-counties-show']) layers.counties.bringToFront();

      //Foreground Layers, in order:
      if(layers.links && session.style.widgets['map-link-show']) layers.links.bringToFront();
      if(layers.nodes && session.style.widgets['map-node-show']) layers.nodes.bringToFront();
    }

    $('#map-node-show').parent().on('click', function(){
      session.style.widgets['map-node-show'] = true;
      drawNodes();
    });
    $('#map-node-hide').parent().on('click', function(){
      session.style.widgets['map-node-show'] = false;
      layers.nodes.remove();
    });

    $('#map-link-show').parent().on('click', function(){
      session.style.widgets['map-link-show'] = true;
      drawLinks();
      if(layers.nodes && session.style.widgets['map-node-show']) layers.nodes.bringToFront();
    });
    $('#map-link-hide').parent().on('click', function(){
      session.style.widgets['map-link-show'] = false;
      layers.links.remove();
    });

    $('#map-countries-show').parent().on('click', function(){
      session.style.widgets['map-countries-show'] = true;
      if(layers.countries){
        layers.countries.addTo(map);
        resetStack();
      } else {
        getMapData('countries', () => $(this).trigger('click'));
      }
    });
    $('#map-countries-hide').parent().on('click', function(){
      session.style.widgets['map-countries-show'] = false;
      layers.countries.remove();
    });

    $('#map-states-show').parent().on('click', function(){
      session.style.widgets['map-states-show'] = true;
      if(layers.states){
        layers.states.addTo(map);
        resetStack();
      } else {
        getMapData('states', () => $(this).trigger('click'));
      }
    });
    $('#map-states-hide').parent().on('click', function(){
      session.style.widgets['map-states-show'] = false;
      layers.states.remove();
    });

    $('#map-counties-show').parent().on('click', function(){
      session.style.widgets['map-counties-show'] = true;
      if(layers.counties){
        layers.counties.addTo(map);
        resetStack();
      } else {
        getMapData('counties', () => $(this).trigger('click'));
      }
    });
    $('#map-counties-hide').parent().on('click', function(){
      session.style.widgets['map-counties-show'] = false;
      layers.counties.remove();
    });

    $('#map-basemap-show').parent().on('click', function(){
      session.style.widgets['map-basemap-show'] = true;
      layers.basemap.addTo(map);
      $('#map-satellite-hide').trigger('click');
      $('#map-countries-hide').trigger('click');
      $('#map-states-hide').trigger('click');
      $('#map-counties-hide').trigger('click');
    });
    $('#map-basemap-hide').parent().on('click', function(){
      session.style.widgets['map-basemap-show'] = false;
      layers.basemap.remove();
      $('#map-countries-show').trigger('click');
      $('#map-states-show').trigger('click');
    });

    $('#map-satellite-show').parent().on('click', function(){
      session.style.widgets['map-satellite-show'] = true;
      layers.satellite.addTo(map);
      $('#map-basemap-hide').trigger('click');
      $('#map-countries-hide').trigger('click');
      $('#map-states-hide').trigger('click');
      $('#map-counties-hide').trigger('click');
    });
    $('#map-satellite-hide').parent().on('click', function(){
      session.style.widgets['map-satellite-show'] = false;
      layers.satellite.remove();
      $('#map-countries-show').trigger('click');
      $('#map-states-show').trigger('click');
      resetStack();
    });

    $('#map-node-transparency').on('change', function(e){
      session.style.widgets['map-node-transparency'] = parseFloat(e.target.value);
      drawNodes();
    });

    $('#map-link-transparency').on('change', function(e){
      session.style.widgets['map-link-transparency'] = parseFloat(e.target.value);
      drawLinks();
    });

    $('#map-node-jitter').on('input', function(e){
      let z = map.getZoom(), z5 = z*5, z9 = z*9,
          v = parseFloat(e.target.value),
          n = nodes.length, rand = d3.randomNormal(0, 20);
      for(let i = 0; i < n; i++){
        nodes[i]._jlon = (rand() * v) / z5;
        nodes[i]._jlat = (rand() * v) / z9;
      }
      session.style.widgets['map-node-jitter'] = v;
      drawLinks();
      drawNodes();
    });

    $('#map-export').on('click', function(){
      let geojson = makeGeoJSON();
      let output;
      let format = $('#map-export-file-format').val();
      if(format === 'shapefile'){
        output = new Blob([shpwrite.zip(geojson)], {type: 'application/zip'});
      } else {
        output = new Blob([JSON.stringify(geojson)], {type: 'application/json;charset=utf-8'});
      }
      saveAs(output, $('#map-export-file-name').val() + '.' + format);
    });

    $(window)
      .on('node-visibility node-selected', function(){
        nodes = app.getVisibleNodes();
        matchCoordinates();
        drawNodes();
      })
      .on('node-color-change', drawNodes)
      .on('link-color-change link-threshold-change link_visibility', drawLinks);

    setTimeout(function(){
      matchCoordinates();
      drawNodes();
      if(layers.nodes.length) map.flyToBounds(layers.nodes.getBounds());
    }, 40);

  })();
  </script>
